# schemas/publicBoardShare.graphql

# Type pour les visiteurs externes
type ExternalVisitor {
  id: ID!
  email: String!
  firstName: String
  lastName: String
  name: String
  image: String
  firstVisitAt: DateTime!
  lastVisitAt: DateTime!
  visitCount: Int!
}

# Type pour les emails bannis
type BannedEmail {
  email: String!
  bannedAt: DateTime!
  reason: String
}

# Type pour les demandes d'accès
type AccessRequest {
  id: ID!
  email: String!
  name: String
  message: String
  requestedAt: DateTime!
  status: String!
}

# Permissions pour le partage public
type PublicSharePermissions {
  canViewTasks: Boolean!
  canComment: Boolean!
  canViewComments: Boolean!
  canViewAssignees: Boolean!
  canViewDueDates: Boolean!
  canViewAttachments: Boolean!
}

# Statistiques d'accès
type PublicShareStats {
  totalViews: Int!
  uniqueVisitors: Int!
  totalComments: Int!
}

# Type principal pour le partage public
type PublicBoardShare {
  id: ID!
  token: String!
  boardId: ID!
  workspaceId: ID!
  createdBy: ID!
  name: String
  permissions: PublicSharePermissions!
  isActive: Boolean!
  expiresAt: DateTime
  hasPassword: Boolean!
  visitors: [ExternalVisitor!]!
  bannedEmails: [BannedEmail!]!
  accessRequests: [AccessRequest!]!
  stats: PublicShareStats!
  createdAt: DateTime!
  updatedAt: DateTime!
  # URL complète pour le partage
  shareUrl: String!
}

# Données du tableau pour les visiteurs externes (version simplifiée)
type PublicBoard {
  id: ID!
  title: String!
  description: String
  columns: [PublicColumn!]!
  tasks: [PublicTask!]!
  members: [PublicAssignedMember!]!
}

type PublicColumn {
  id: ID!
  title: String!
  color: String!
  order: Int!
}

type PublicTask {
  id: ID!
  title: String!
  description: String
  status: String!
  priority: String
  tags: [Tag!]
  startDate: DateTime
  dueDate: DateTime
  columnId: String!
  position: Int
  checklist: [ChecklistItem!]
  assignedMembers: [PublicAssignedMember!]
  comments: [PublicComment!]
  timeTracking: PublicTimeTracking
  userId: ID
  createdAt: DateTime
  updatedAt: DateTime
}

type PublicTimeTracking {
  totalSeconds: Int
  isRunning: Boolean
  hourlyRate: Float
}

type PublicAssignedMember {
  id: String!
  name: String!
  image: String
}

type PublicComment {
  id: ID!
  userName: String!
  userEmail: String
  userImage: String
  content: String!
  isExternal: Boolean!
  createdAt: DateTime!
}

# Input pour créer un lien de partage
input CreatePublicShareInput {
  boardId: ID!
  name: String
  permissions: PublicSharePermissionsInput
  expiresAt: DateTime
  password: String
}

input PublicSharePermissionsInput {
  canViewTasks: Boolean
  canComment: Boolean
  canViewComments: Boolean
  canViewAssignees: Boolean
  canViewDueDates: Boolean
  canViewAttachments: Boolean
}

# Input pour mettre à jour un lien de partage
input UpdatePublicShareInput {
  id: ID!
  name: String
  permissions: PublicSharePermissionsInput
  isActive: Boolean
  expiresAt: DateTime
  password: String
}

# Résultat de l'accès public
type PublicAccessResult {
  success: Boolean!
  message: String
  board: PublicBoard
  share: PublicBoardShare
  visitorEmail: String
  isBanned: Boolean
}

# Résultat de l'ajout de commentaire externe
type ExternalCommentResult {
  success: Boolean!
  message: String
  task: PublicTask
}

# Input pour mettre à jour le profil d'un visiteur externe
input UpdateVisitorProfileInput {
  firstName: String
  lastName: String
  image: String
}

# Résultat de la mise à jour du profil
type UpdateVisitorProfileResult {
  success: Boolean!
  message: String
  visitor: ExternalVisitor
}

# Résultat de la demande d'accès
type RequestAccessResult {
  success: Boolean!
  message: String
  alreadyRequested: Boolean
}

# Queries pour le partage public
extend type Query {
  # Pour les utilisateurs connectés - récupérer les liens de partage d'un tableau
  getPublicShares(boardId: ID!, workspaceId: ID): [PublicBoardShare!]!
  
  # Pour les visiteurs externes - accéder au tableau via le token
  getPublicBoard(token: String!, email: String!, password: String): PublicAccessResult!
  
  # Vérifier si un token est valide (sans email)
  validatePublicToken(token: String!): Boolean!
}

# Mutations pour le partage public
extend type Mutation {
  # Pour les utilisateurs connectés
  createPublicShare(input: CreatePublicShareInput!, workspaceId: ID): PublicBoardShare!
  updatePublicShare(input: UpdatePublicShareInput!, workspaceId: ID): PublicBoardShare!
  deletePublicShare(id: ID!, workspaceId: ID): Boolean!
  revokePublicShare(id: ID!, workspaceId: ID): Boolean!
  
  # Révoquer l'accès d'un visiteur spécifique (le bannit)
  revokeVisitorAccess(shareId: ID!, visitorEmail: String!, reason: String, workspaceId: ID): PublicBoardShare!
  
  # Débannir un visiteur
  unbanVisitor(shareId: ID!, visitorEmail: String!, workspaceId: ID): PublicBoardShare!
  
  # Demander l'accès (pour les visiteurs bannis)
  requestAccess(token: String!, email: String!, name: String, message: String): RequestAccessResult!
  
  # Approuver une demande d'accès
  approveAccessRequest(shareId: ID!, requestId: ID!, workspaceId: ID): PublicBoardShare!
  
  # Rejeter une demande d'accès
  rejectAccessRequest(shareId: ID!, requestId: ID!, workspaceId: ID): PublicBoardShare!
  
  # Pour les visiteurs externes - ajouter un commentaire
  addExternalComment(
    token: String!
    taskId: ID!
    content: String!
    visitorEmail: String!
  ): ExternalCommentResult!
  
  # Pour les visiteurs externes - mettre à jour leur profil
  updateVisitorProfile(
    token: String!
    email: String!
    input: UpdateVisitorProfileInput!
  ): UpdateVisitorProfileResult!
}

# Payload pour la subscription de mise à jour de tâche publique
type PublicTaskUpdatePayload {
  type: String!
  task: PublicTask
  taskId: ID
  boardId: ID
}

# Payload pour la subscription d'accès approuvé
type AccessApprovedPayload {
  email: String!
  token: String!
  approved: Boolean!
}

# Payload pour la subscription d'accès révoqué
type AccessRevokedPayload {
  email: String!
  token: String!
  reason: String
}

# Payload pour la subscription de nouvelle demande d'accès
type AccessRequestPayload {
  id: ID!
  email: String!
  name: String
  message: String
  requestedAt: DateTime!
  boardId: ID!
}

# Payload pour la subscription de visiteur connecté/déconnecté
type VisitorPresencePayload {
  email: String!
  name: String
  image: String
  boardId: ID!
  isConnected: Boolean!
}

extend type Subscription {
  # Subscription pour les mises à jour de tâches sur un board public
  publicTaskUpdated(token: String!, boardId: ID!): PublicTaskUpdatePayload
  
  # Subscription pour notifier quand un accès est approuvé (pour les visiteurs en attente)
  accessApproved(token: String!, email: String!): AccessApprovedPayload
  
  # Subscription pour notifier quand un accès est révoqué (déconnexion en temps réel)
  accessRevoked(token: String!, email: String!): AccessRevokedPayload
  
  # Subscription pour notifier le propriétaire d'une nouvelle demande d'accès
  accessRequested(boardId: ID!): AccessRequestPayload
  
  # Subscription pour voir les visiteurs connectés en temps réel
  visitorPresence(boardId: ID!): VisitorPresencePayload
}
