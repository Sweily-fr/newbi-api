name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch: # Permet le d√©clenchement manuel

jobs:
  deploy:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -H 51.91.254.74 >> ~/.ssh/known_hosts

      - name: Deploy to Staging
        env:
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: |
          echo "üöÄ D√©ploiement STAGING en cours..."
          
          # Sync files
          rsync -avz --exclude='uploads' --exclude='node_modules' --exclude='.git' \
            -e 'ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no' \
            ./* joaquim@51.91.254.74:~/staging
          
          # Execute deployment commands
          ssh -i ~/.ssh/vps_key -o StrictHostKeyChecking=no joaquim@51.91.254.74 << 'ENDSSH'
            source ~/.nvm/nvm.sh
            cd staging
            
            echo "üîÑ V√©rification Redis..."
            if redis.cli -a "$REDIS_PASSWORD" ping > /dev/null 2>&1; then
              echo "‚úÖ Redis op√©rationnel"
            else
              echo "‚ùå Redis probl√®me - red√©marrage..."
              sudo snap restart redis
              sleep 3
              if redis.cli -a "$REDIS_PASSWORD" ping > /dev/null 2>&1; then
                echo "‚úÖ Redis red√©marr√© avec succ√®s"
              else
                echo "‚ö†Ô∏è Redis indisponible - l'app utilisera le fallback m√©moire"
              fi
            fi
            
            echo "üì¶ Installation des d√©pendances..."
            npm ci --omit=dev
            npm install
            
            echo "üîÑ Rechargement PM2..."
            pm2 reload newbi-staging
            
            echo "‚úÖ V√©rification du statut..."
            pm2 status newbi-staging
            
            echo "üéâ D√©ploiement STAGING termin√© avec succ√®s!"
          ENDSSH

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/vps_key

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ D√©ploiement STAGING r√©ussi!"
          echo "üåê URL: https://staging.newbi.fr (ou votre URL staging)"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå D√©ploiement STAGING √©chou√©!"
          echo "üìã V√©rifiez les logs ci-dessus pour plus de d√©tails"
